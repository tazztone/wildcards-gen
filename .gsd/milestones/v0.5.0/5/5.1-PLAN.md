---
phase: 5
plan: fix-regressions
wave: 1
gap_closure: true
---

# Fix: Regression Repair

## Problem
- **Missing Import**: `NameError: name 'Tuple' is not defined` in `wildcards_gen/core/progress.py`.
- **Tencent Crash**: `AttributeError: 'dict' object has no attribute 'lower'` in `wildcards_gen/core/datasets/tencent.py`.
- **Test Suite Rot**: `test_datasets.py` calls `.cache_clear()` on function that is no longer cached via decorator.

## Root Cause
- **Import**: `Tuple` was used in type hint but not imported from `typing`.
- **Tencent**: Refactoring in previous phases likely introduced a path where `child_val` returns a dict (orphans/structure) instead of list of strings, and flattening logic wasn't updated to handle it.
- **Tests**: We replaced `@lru_cache` with manual `_OPENIMAGES_CACHE` but didn't update tests that clear it.

## Tasks

<task type="auto">
  <name>Fix Progress Import</name>
  <files>wildcards_gen/core/progress.py</files>
  <action>
    Add `from typing import Tuple, Optional` (if missing) to `wildcards_gen/core/progress.py`.
  </action>
  <verify>uv run pytest tests/test_imports_walk.py</verify>
  <done>Import error resolved</done>
</task>

<task type="auto">
  <name>Fix Tencent Flattening</name>
  <files>wildcards_gen/core/datasets/tencent.py</files>
  <action>
    Modify `tencent.py` around line 438.
    Ensure `leaves` only contains strings.
    If `child_val` is a dict (meaning it has structure/orphans), `merge_nodes` handles it, but the flattening logic for `leaves` accumulation needs to handle nested dict extraction or be robust.
    The error is in `[l for l in leaves if l.lower() != normalized_name]`.
    Fix: Filter `leaves` to ensure they are strings before case-folding, or fix the extraction source (`collect_leaves`) to strictly return strings.
  </action>
  <verify>uv run pytest tests/test_tencent.py</verify>
  <done>Tencent generation passes</done>
</task>

<task type="auto">
  <name>Fix Test Suite Cache Clearing</name>
  <files>tests/test_datasets.py</files>
  <action>
    Replace `load_openimages_data.cache_clear()` with:
    ```python
    from wildcards_gen.core.datasets import openimages
    openimages._OPENIMAGES_CACHE = None
    ```
    (Or expose a helper `openimages.clear_cache()`).
  </action>
  <verify>uv run pytest tests/test_datasets.py</verify>
  <done>AttributeError removed</done>
</task>

## Success Criteria
- [ ] `uv run pytest` (full suite) passes or has significantly fewer errors.
