---
phase: 6
plan: 1
wave: 1
---

# Plan 6.1: Service Restoration

## Objective
Restore the test suite to a passing state by aligning stale tests with the evolved codebase.

## Context
- .gsd/SPEC.md
- .gsd/ARCHITECTURE.md
- .gsd/phases/6/RESEARCH.md

## Tasks

<task type="auto">
  <name>Fix Arranger Tests</name>
  <files>
    tests/test_arranger.py
    tests/test_arranger_umap.py
    wildcards_gen/core/arranger.py
  </files>
  <action>
    1. In `test_arranger_umap.py`, enforce cache clearing for UMAP logic to ensure mocks are called.
    2. In `test_arranger.py`, update `test_arrange_list_basic` and others to handle new default return structures (tuples).
  </action>
  <verify>uv run pytest tests/test_arranger.py tests/test_arranger_umap.py</verify>
  <done>All arranger tests pass</done>
  <status>DONE</status>
</task>

<task type="auto">
  <name>Fix Dataset Tests</name>
  <files>
    tests/test_dataset_fixes.py
    tests/test_fast_preview.py
  </files>
  <action>
    1. Update `test_dataset_fixes.py` mocks to return `(structure, leftovers)` tuples instead of raw dicts/lists.
    2. Update `test_fast_preview.py` mocks to return sortable strings for names/IDs to prevent `TypeError`.
  </action>
  <verify>uv run pytest tests/test_dataset_fixes.py tests/test_fast_preview.py</verify>
  <done>Tests pass without AttributionError or TypeError</done>
  <status>DONE</status>
</task>

<task type="auto">
  <name>Fix Shaper Tests</name>
  <files>
    tests/test_shaper.py
  </files>
  <action>
    1. Update `test_flatten_singles` to explicitly disable `preserve_roots` if that is the cause of failure, OR adjust the assertion if the behavior is intentional.
    2. Ensure `test_integration_pipeline` mocks match new `arrange` signatures.
  </action>
  <verify>uv run pytest tests/test_shaper.py tests/test_integration_pipeline.py</verify>
  <done>All tests pass</done>
  <status>DONE</status>
</task>

## Success Criteria
- [ ] `uv run pytest` returns exit code 0.
