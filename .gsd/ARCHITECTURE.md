# Architecture

> Auto-generated by /map on 2026-01-30

## Overview

`wildcards-gen` is a Python-based toolkit designed to generate structured YAML "skeletons" for AI prompt management. It bridges formal taxonomies (WordNet) with data-driven clustering (Embeddings) and generative logic (LLMs).

```
┌─────────────────────────────────────────┐
│          CLI (cli.py) / GUI (gui.py)    │
├─────────────────────────────────────────┤
│       Structure Manager (structure.py)  │
├─────────────────────────────────────────┤
│  Dataset Generators | LLM Engine | Smart │
├─────────────────────────────────────────┤
│    WordNet (NLTK) | HDBSCAN | Embeddings │
└─────────────────────────────────────────┘
```

## Components

### CLI Entry Point
- **Purpose:** Command orchestration and argument parsing.
- **Location:** `wildcards_gen/cli.py`
- **Dependencies:** `argparse`, `ConfigManager`, `presets`.

### GUI Interface
- **Purpose:** Web-based interface for low-friction generation and tools.
- **Location:** `wildcards_gen/gui.py`
- **Dependencies:** `gradio`, `StructureManager`.

### Core Logic
- **Structure Manager (`core/structure.py`):** Wraps `ruamel.yaml` to ensure comment preservation.
- **Config Manager (`core/config.py`):** Handles hierarchical configuration overrides.
- **LLM Engine (`core/llm.py`):** Interface for OpenRouter, handles prompt injection and response cleaning.
- **WordNet Wrapper (`core/wordnet.py`):** Interface for NLTK WordNet, provides definitions and hierarchy traversal.
- **Smart Mode (`core/smart.py`):** Implements semantic pruning, flattening, and leaf bubbling.
- **Arranger (`core/arranger.py`):** HDBSCAN-based semantic clustering for flat leaf lists.

### Datasets (`core/datasets/`)
- Implements specialized logic for parsing metadata from ImageNet, COCO, OpenImages, and Tencent.

## Data Flow

1. **Initialization:** CLI/GUI initializes `ConfigManager` and selects a command/task.
2. **Generation:**
   - **Dataset:** Parses local metadata -> Maps to WordNet -> Recursively builds tree -> Applies Smart Pruning.
   - **Create/Categorize:** Sends terms/prompt to LLM -> Cleans response -> Parses into structure.
3. **Refinement:** (Optional) Semantic Arrangement clusters flat lists into named subgroups.
4. **Serialization:** `StructureManager` converts internal `CommentedMap` (with instruction comments) to a YAML file.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| OpenRouter | API | LLM generation for `create/categorize/enrich` |
| NLTK WordNet| Local DB | Semantic backbone for datasets and naming |
| HuggingFace | Local Models | Vector embeddings for Linter and Arranger |

## Technical Debt

- [ ] **Dependency Inconsistency:** Gradio missing from `pyproject.toml` but in `requirements.txt`.
- [ ] **Prompt Coupling:** Prompts are text files in `prompts/`, but some logic is still in `llm.py`.
- [ ] **Sync Execution:** Long-running dataset generations are synchronous and can block the GUI.

## Conventions

**Naming:** Snake_case for functions/variables, PascalCase for classes.
**Structure:** Modular "Core" vs "Dataset" separation.
**Testing:** Pytest focused on contract validation and CLI smoke tests.
