# Architecture

> Auto-generated by /map on 2026-02-05

## Overview

`wildcards-gen` is a tool for generating structured wildcard YAML files for AI image generation. It uses NLP and ML techniques (WordNet, Embeddings, Clustering) to organize flat lists of terms into semantic hierarchies.

```
┌─────────────────────────────────────────┐
│              [CLI / GUI]                │
│       (cli.py, gui.py, scripts/)        │
├─────────────────────────────────────────┤
│         [Business Logic Layer]          │
│ (core/arranger, shaper, wordnet, batch) │
├─────────────────────────────────────────┤
│            [Data Layer]                 │
│    (SQLite Cache, WordNet, Models)      │
└─────────────────────────────────────────┘
```

## Components

### Core Logic
- **Purpose:** Semantic organization and hierarchy generation.
- **Location:** `wildcards_gen/core/`
- **Key Files:**
    - `arranger.py`: Main clustering and naming logic.
    - `shaper.py`: Post-processing (flattening, constraining).
    - `wordnet.py`: NLTK WordNet integration.
    - `linter.py`: Dependency checks and embedding computation.
- **Dependencies:** `nltk`, `sentence-transformers`, `hdbscan`, `numpy`, `scikit-learn`

### User Interface
- **Purpose:** User interaction via Command Line or Web GUI.
- **Location:** `wildcards_gen/`
- **Key Files:**
    - `cli.py`: Entry point for batch/command-line operations.
    - `gui.py`: Gradio-based web interface.
- **Dependencies:** `gradio`, `click` (via cli)

### Scripts
- **Purpose:** Deployment, verification, and platform-specific runners.
- **Location:** `scripts/`
- **Contents:** `linux/`, `windows/`, `verify_tencent_integration.py`

## Data Flow

1. **Input:** User provides a list of terms or selects a dataset (Tencent, ImageNet).
2. **Processing:**
   - `arranger.py` computes embeddings (cached in SQLite).
   - HDBSCAN/UMAP clusters terms.
   - WordNet finds LCAs (Lowest Common Ancestors) for clusters.
3. **Refinement:** `shaper.py` flattens and names the hierarchy.
4. **Output:** Structured YAML file.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| SQLite | Local DB | Caching embeddings to disk |
| WordNet | NLTK | Semantic lookups and hierarchy naming |
| HuggingFace | Model | `sentence-transformers` for embeddings |

## Technical Debt

- [ ] `wildcards_gen/core/arranger.py`: "Matter" root hallucination (missing strict blacklist).
- [ ] `wildcards_gen/core/shaper.py`: Overly conservative flattening logic leads to deep nesting.
- [ ] `wildcards_gen/core/arranger.py`: Tautology handling in `_generate_descriptive_name` could be more robust.

## Conventions

**Naming:** Python snake_case for functions/files. Classes are PascalCase.
**Structure:** Modular `core` package with clear separation of concerns (arrange vs shape).
**Testing:** Pytest suite in `tests/` mirroring the package structure.
