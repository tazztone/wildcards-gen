# Architecture

> Auto-generated by /map on 2026-01-30 (Merged with Domain Knowledge)

## Overview

`wildcards-gen` is a tool for generating hierarchical, human-readable YAML "skeleton" files for AI image generation wildcards. It ingests large taxonomies (ImageNet, OpenImages, Tencent ML-Images, COCO), processes them using data science techniques (semantic arrangement, pruning, clustering), and outputs structured YAML files with preserved comments.

```mermaid
graph TD
    CLI[CLI (cli.py)] --> Core
    GUI[GUI (gui.py)] --> Core
    
    subgraph Core
        Smart[Smart Logic (smart.py)]
        Arranger[Arranger (arranger.py)]
        Shaper[Shaper (shaper.py)]
        Struct[Structure Mgr (structure.py)]
        
        subgraph Datasets
            IN[ImageNet]
            OI[OpenImages]
            TN[Tencent]
            CO[COCO]
        end
    end
    
    Core --> Analytics[Analytics (metrics.py)]
    Smart --> Arranger
    Smart --> Shaper
    Datasets --> Smart
    Datasets --> Struct
```

## Mental Model & Implementation Details

### 1. The "Skeleton" Concept
This tool produces **skeletons**: structured YAML files with categories and instructions, but minimal leaf nodes. These skeletons are imported into the `wildcards-generator` SPA, where the AI populates them with extensive wildcards.
- **Goal**: precise structure, helpful context instructions.
- **Non-Goal**: generating millions of wildcards (that's the SPA's job).

### 2. Strict Comment Preservation
The `# instruction:` comment is the payload. It tells the downhill AI what a category *means*.
- **Implementation**: Uses `ruamel.yaml` via `StructureManager` (`core/structure.py`).
- **Rule**: NEVER use standard `yaml` or `PyYAML` libraries, as they strip comments.

### 3. Hybrid Data Sources
- **WordNet (Trusted)**: Used for `dataset` commands. Maps IDs (WNID, Freebase) to WordNet Synsets.
- **LLM (Flexible)**: Used for `categorize/create`. Uses `LLMEngine` for prompt injection and response cleaning.

### 4. Smart Mode Pruning Logic
- **Significance**: Uses WordNet depth/branching to keep meaningful categories while flattening obscure intermediates.
- **Node Elision**: Nodes in `SKIP_NODES` are logically removed while promoting children.
- **Orphan Bubbling**: Small lists are bubbled up to `other_{parent}:` keys.
- **Self-Reference Filtering**: Filters out leaf nodes that are identical to their parent category name (e.g., `nose: - nose` is forbidden) to reduce redundancy.

### 5. Semantic Arrangement (Arranger)
- **Clustering**: HDBSCAN-based density clusters (min size 3) with UMAP dimensionality reduction.
- **Naming**: Calculates medoid, queries hypernym (e.g., basil -> herb), and appends medoid if generic: `LCA (Medoid)`.
- **Recursion**: Clusters are recursively processed to handle high-cardinality leaves.

### 6. Constraint Shaping (Shaper)
- **Orphan Merging**: Small sibling groups (< `min_leaf_size`) are merged into a "misc" grouping.
- **Flatten Singles**: Unnecessary single-path nesting is promoted up the tree.

## Components

### Core Components (`wildcards_gen/core/`)
- **Structure Manager (`structure.py`)**: Wraps `ruamel.yaml` to handle `CommentedMap` preservation.
- **Smart Manager (`smart.py`)**: Configuration hub for "Smart Mode" and entry point for semantic operations.
- **Arranger (`arranger.py`)**: The "Brain". Uses `sentence-transformers`, `UMAP`, and `HDBSCAN` to recursively cluster large lists of terms.
- **Shaper (`shaper.py`)**: The "Editor". Post-processes generated hierarchies to enforce constraints.
- **Linter (`linter.py`)**: Analyzes YAML files for structural quality, identifying "outliers".
- **WordNet (`wordnet.py`)**: NLTK wrapper for fetching synsets, glosses, and traversing hypernym paths.
- **LLM Engine (`llm.py`)**: Interfaces with OpenRouter for `create`/`categorize` commands, handling prompt injection and response cleaning.

### Datasets (`wildcards_gen/core/datasets/`)
- **ImageNet (`imagenet.py`)**: Generates hierarchy from ImageNet-1k/21k synsets.
- **OpenImages (`openimages.py`)**: Parses OpenImages JSON hierarchy.
- **Tencent (`tencent.py`)**: Parses Tencent ML-Images hierarchy.
- **COCO (`coco.py`)**: Simple COCO category generator.

### Entry Points
- **CLI (`cli.py`)**: Main command-line interface. Supports generation and analysis.
- **GUI (`gui.py`)**: Gradio-based web interface exposing generation and linting tools.

## Data Flow

1. **Initialization:** CLI/GUI initializes `ConfigManager` and selects a command/task.
2. **Generation:**
   - **Dataset:** Parses local metadata -> Maps to WordNet -> Recursively builds tree -> Applies Smart Pruning.
   - **Create/Categorize:** Sends terms/prompt to LLM -> Cleans response -> Parses into structure.
3. **Refinement:** `Arranger` recursively clusters flat lists into named subgroups (Semantic Arrangement).
4. **Shaping:** `ConstraintShaper` post-processes the tree (merges orphans, flattens singles).
5. **Serialization:** `StructureManager` converts internal `CommentedMap` (with instruction comments) to a YAML file.

## Service Roles & Integration

| Service | Type | Purpose |
|---------|------|---------|
| OpenRouter | API | LLM generation for `create/categorize/enrich` |
| NLTK WordNet| Local DB | Semantic backbone for datasets and naming |
| HuggingFace | Local Models | Vector embeddings for Linter and Arranger |

## UI/UX Principles (GUI)
- **Consolidated Workflow**: Builder tab for generation, Tools tab for post-processing, Settings for config.
- **Documentation**: Use `info=` for guidance. **Do NOT use `tooltip=`** (not supported in current Gradio version).
- **Progressive Disclosure**: Use `gr.Accordion` for advanced tuning.

## Conventions
- **Naming**: Snake_case for modules/functions. CamelCase for classes.
- **Typing**: Strict type hints used throughout.
- **Testing**: `pytest` fixture-based testing in `tests/`.
