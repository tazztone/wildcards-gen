# Architecture

> Auto-generated by /map on 2026-01-30

## Overview

`wildcards-gen` is a tool for generating hierarchical, human-readable YAML "skeleton" files for AI image generation wildcards. It ingests large taxonomies (ImageNet, OpenImages, Tencent ML-Images, COCO), processes them using data science techniques (semantic arrangement, pruning, clustering), and outputs structured YAML files with preserved comments.

```mermaid
graph TD
    CLI[CLI (cli.py)] --> Core
    GUI[GUI (gui.py)] --> Core
    
    subgraph Core
        Smart[Smart Logic (smart.py)]
        Arranger[Arranger (arranger.py)]
        Shaper[Shaper (shaper.py)]
        Struct[Structure Mgr (structure.py)]
        
        subgraph Datasets
            IN[ImageNet]
            OI[OpenImages]
            TN[Tencent]
            CO[COCO]
        end
    end
    
    Core --> Analytics[Analytics (metrics.py)]
    Smart --> Arranger
    Smart --> Shaper
    Datasets --> Smart
    Datasets --> Struct
```

## Structure

### Entry Points
- **CLI (`cli.py`)**: Main command-line interface. Supports generation (`generate`) and analysis (`compare`, `structure`, `lint`).
- **GUI (`gui.py`)**: Gradio-based web interface exposing generation and linting tools.

### Core Components (`wildcards_gen/core/`)
- **Structure Manager (`structure.py`)**: Wraps `ruamel.yaml` to handle `CommentedMap` preservation, ensuring `# instruction:` comments survive manipulation.
- **Smart Manager (`smart.py`)**: Configuration hub for "Smart Mode" (pruning, clustering parameters) and entry point for semantic operations.
- **Arranger (`arranger.py`)**: The "Brain". Uses `sentence-transformers`, `UMAP`, and `HDBSCAN` to recursively cluster large lists of terms into semantic hierarchies.
- **Shaper (`shaper.py`)**: The "Editor". Post-processes generated hierarchies to enforce constraints (min leaf size, orphan merging, flattening singles).
- **Linter (`linter.py`)**: Analyzes YAML files for structural quality, identifying "outliers" (semantic anomalies) and large lists.
- **WordNet (`wordnet.py`)**: NLTK wrapper for fetching synsets, glosses, and traversing hypernym paths.

### Datasets (`wildcards_gen/core/datasets/`)
- **ImageNet (`imagenet.py`)**: Generates hierarchy from ImageNet-1k/21k synsets.
- **OpenImages (`openimages.py`)**: Parses OpenImages JSON hierarchy.
- **Tencent (`tencent.py`)**: Parses Tencent ML-Images hierarchy.
- **COCO (`coco.py`)**: Simple COCO category generator.
- **Downloaders (`downloaders.py`)**: Handles lazy downloading and caching of dataset files.

### Analytics (`wildcards_gen/analytics/`)
- **Metrics (`metrics.py`)**: Calculates Jaccard Index, ARI, and other stability metrics.
- **Comparator (`comparator.py`)**: Compares two YAML skeletons for structural differences.

## Data Flow
1. **Input**: User selects dataset (e.g., ImageNet) and root node (e.g., "dog").
2. **Traversal**: Dataset module traverses the source hierarchy (WordNet/JSON).
3. **Pruning**: `SmartConfig` filters nodes based on depth or semantic significance.
4. **Arrangement**: If a leaf list is too large, `Arranger` recursively clusters it using embeddings.
5. **Shaping**: `ConstraintShaper` post-processes the tree (merges orphans, flattens singles).
6. **Output**: `StructureManager` writes the final `CommentedMap` to YAML.

## Technical Debt
- [ ] No explicit technical debt markers (TODO/FIXME) found in scan.
- [ ] Integration of `ConstraintShaper` in OpenImages/Tencent was explicitly handled in recent Gap Closure.

## Conventions
- **Naming**: Snake_case for modules/functions. CamelCase for classes.
- **Typing**: Strict type hints used throughout.
- **Testing**: `pytest` fixture-based testing in `tests/`.
